#!KAMAILIO
#
# Kamailio SIP Proxy Configuration
# Purpose: Route SIP calls from source Twilio account to destination Twilio account
#

####### Global Parameters #########

# Logging
debug=4
log_stderror=no
log_facility=LOG_LOCAL0
log_prefix="{$mt $hdr(CSeq) $ci} "

# Network settings
# PRIVATE_IP and ELASTIC_IP will be replaced by user-data script
listen=udp:PRIVATE_IP:5060
advertise ELASTIC_IP:5060

# Multi-homed support (EC2 has both private and public IPs)
mhomed=1

# Fork and run as daemon
fork=yes
children=4

# Disable TCP
disable_tcp=yes

# DNS settings
dns=yes
rev_dns=no
dns_try_ipv6=no

# Aliases
# ELASTIC_IP will be replaced by user-data script
alias=ELASTIC_IP:5060

####### Modules Section ########

# Module path
mpath="/usr/lib/x86_64-linux-gnu/kamailio/modules/"

# Load modules
loadmodule "tm.so"         # Transaction module
loadmodule "tmx.so"        # Transaction extensions
loadmodule "sl.so"         # Stateless replies
loadmodule "rr.so"         # Record-Route
loadmodule "pv.so"         # Pseudo-variables
loadmodule "maxfwd.so"     # Max-Forwards check
loadmodule "textops.so"    # Text operations
loadmodule "siputils.so"   # SIP utilities
loadmodule "xlog.so"       # Extended logging
loadmodule "ctl.so"        # Control interface
loadmodule "kex.so"        # Core extensions

# Module parameters

# tm module parameters
modparam("tm", "failure_reply_mode", 3)
modparam("tm", "fr_timer", 30000)
modparam("tm", "fr_inv_timer", 120000)

# rr module parameters
modparam("rr", "append_fromtag", 0)

####### Routing Logic ########

# Main request route
request_route {
    # Log all incoming requests
    xlog("L_INFO", "===== INCOMING REQUEST =====\n");
    xlog("L_INFO", "Method: $rm | From: $fu | To: $tu | R-URI: $ru\n");
    xlog("L_INFO", "Source IP: $si:$sp\n");

    # Check Max-Forwards to prevent loops
    if (!mf_process_maxfwd_header("70")) {
        xlog("L_WARN", "Too many hops - Max-Forwards exceeded\n");
        sl_send_reply("483", "Too Many Hops");
        exit;
    }

    # Handle CANCEL processing
    if (is_method("CANCEL")) {
        if (t_check_trans()) {
            xlog("L_INFO", "CANCEL request - relaying\n");
            route(RELAY);
        }
        exit;
    }

    # Handle retransmissions
    if (!is_method("ACK")) {
        if (t_precheck_trans()) {
            t_check_trans();
            exit;
        }
        t_check_trans();
    }

    # Handle in-dialog requests (has To-tag)
    if (has_totag()) {
        xlog("L_INFO", "In-dialog request detected\n");

        if (loose_route()) {
            xlog("L_INFO", "Loose routing applied\n");
            route(RELAY);
        } else {
            if (is_method("ACK")) {
                if (t_check_trans()) {
                    xlog("L_INFO", "ACK matched transaction\n");
                    route(RELAY);
                }
                exit;
            }
            xlog("L_WARN", "In-dialog request without Route header\n");
            sl_send_reply("404", "Not Here");
        }
        exit;
    }

    # MAIN ROUTING LOGIC: Process INVITE from Twilio only
    # Only accept INVITEs from Twilio IP ranges (54.172.x.x, 54.244.x.x, 177.71.x.x)
    if (is_method("INVITE") && ($si =~ "^54\.172\." || $si =~ "^54\.244\." || $si =~ "^177\.71\.")) {
        xlog("L_INFO", "Twilio INVITE received from $si\n");
        xlog("L_INFO", "Original R-URI: $ru\n");

        # Extract username from Request-URI
        $var(user) = $rU;

        # Rewrite destination to Twilio SIP Domain
        # DESTINATION_DOMAIN will be replaced by user-data script
        $ru = "sip:" + $var(user) + "@DESTINATION_DOMAIN";

        xlog("L_INFO", "Rewritten R-URI: $ru\n");

        # Record-Route to stay in signaling path
        record_route_preset("ELASTIC_IP:5060");

        # Route the call
        route(RELAY);
        exit;
    }

    # Reject everything else
    xlog("L_WARN", "Rejecting request: method=$rm from IP=$si\n");
    sl_send_reply("403", "Forbidden");
    exit;
}

# Relay route - forward requests
route[RELAY] {
    xlog("L_INFO", "===== RELAYING REQUEST =====\n");
    xlog("L_INFO", "Final R-URI: $ru\n");

    # Remove all X-Twilio-* headers before forwarding
    if (remove_hf_re("^X-Twilio-")) {
        xlog("L_INFO", "Removed X-Twilio-* headers from outbound request\n");
    }

    # Relay using transaction module
    if (!t_relay()) {
        xlog("L_ERR", "Failed to relay request\n");
        sl_reply_error();
    }

    exit;
}

# Response handling
onreply_route {
    xlog("L_INFO", "===== RESPONSE RECEIVED =====\n");
    xlog("L_INFO", "Status: $rs $rr | From: $fu | To: $tu\n");
    xlog("L_INFO", "Source IP: $si:$sp\n");

    # Remove all X-Twilio-* headers before forwarding response back to source
    if (remove_hf_re("^X-Twilio-")) {
        xlog("L_INFO", "Removed X-Twilio-* headers from response\n");
    }
}

# Transaction failure route
failure_route[FAIL_ROUTE] {
    xlog("L_INFO", "===== TRANSACTION FAILURE =====\n");
    xlog("L_INFO", "Status: $T_reply_code | Reason: $T_reply_reason\n");

    # You can add retry logic here if needed
}

# Branch route - called for each branch
branch_route {
    xlog("L_INFO", "===== NEW BRANCH =====\n");
    xlog("L_INFO", "Branch R-URI: $ru\n");
}
